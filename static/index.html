<!DOCTYPE html>
<html lang='ru'>
<head>
  <meta charset='UTF-8'>
  <title>Click Counter Pro</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    input, button {
      margin: 5px;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
    }
    button {
      cursor: pointer;
      transition: transform 0.1s;
    }
    button:hover { transform: scale(1.05); }
    .inc { background: #e63946; color: white; }
    .dec { background: #457b9d; color: white; }
    .reset { background: #2a9d8f; color: white; }
    #stats { margin-top: 20px; font-size: 24px; }
    #error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Click Counter Pro</h1>

  <div id='login'>
    <input id='username' placeholder='Введите имя' />
    <button id='start'>Начать</button>
  </div>

  <div id='main' style='display:none;'>
    <button class='inc'>+</button>
    <button class='dec'>-</button>
    <button class='reset'>Сброс</button>
    <div id='stats'>
      Ты: <span id='user_count'>0</span> |
      Все вместе: <span id='total_count'>0</span>
    </div>
    <div id='error'></div>
  </div>

  <script>
    const usernameInput = document.getElementById('username');
    const startBtn = document.getElementById('start');
    const mainDiv = document.getElementById('main');
    const stats = document.getElementById('stats');
    const errorDiv = document.getElementById('error');
    const userSpan = document.getElementById('user_count');
    const totalSpan = document.getElementById('total_count');

    let username = null;
    let ws = null;

    startBtn.onclick = async () => {
      username = usernameInput.value.trim();
      if (!username) return alert('Введите имя!');

      await fetch('/register', {
        method: 'POST',
        body: new URLSearchParams({ username }),
      });

      document.getElementById('login').style.display = 'none';
      mainDiv.style.display = 'block';
      connectWS();
      updateStats();
    };

    async function sendAction(action) {
      const res = await fetch('/action', {
        method: 'POST',
        body: new URLSearchParams({ username, action }),
      });
      const data = await res.json();
      if (data.error) errorDiv.textContent = data.error;
      else {
        errorDiv.textContent = '';
        updateUserStats(data.user_count, data.total);
      }
    }

    async function updateStats() {
      const res = await fetch(`/stats?username=${username}`);
      const data = await res.json();
      updateUserStats(data.user_count, data.total);
    }

    function updateUserStats(userCount, totalCount) {
      const oldUserCount = parseInt(userSpan.textContent);
      userSpan.textContent = userCount;
      totalSpan.textContent = totalCount;

      if (userCount > oldUserCount) {
        userSpan.style.color = '#228B22';
      } else if (userCount < oldUserCount) {
        userSpan.style.color = '#e63946';
      }
    
      userSpan.style.transition = 'color 0.3s';
      setTimeout(() => userSpan.style.color = '#333', 300);
    }

    function connectWS() {
      ws = new WebSocket(`ws://${location.host}/ws`);
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.total !== undefined) {
          const oldTotal = parseInt(totalSpan.textContent);
          totalSpan.textContent = data.total;
          
          if (totalSpan.textContent > oldTotal) {
            totalSpan.style.color = '#006400';
          } else if (totalSpan.textContent < oldTotal) {
            totalSpan.style.color = '#8B0000';
          }
          totalSpan.style.transition = 'color 0.3s';
          setTimeout(() => totalSpan.style.color = '#333', 300);
        }
      };
    }

    document.querySelector('.inc').onclick = () => sendAction('inc');
    document.querySelector('.dec').onclick = () => sendAction('dec');
    document.querySelector('.reset').onclick = () => sendAction('reset');
  </script>
</body>
</html>
